<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GC LLM Governance Charter — apercue.ca</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible+Mono:ital,wght@0,200..800;1,200..800&family=Atkinson+Hyperlegible+Next:ital,wght@0,200..800;1,200..800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0e14;
  --bg-panel: #0f1319;
  --bg-hover: #151b24;
  --bg-card: #121820;
  --border: #1e2733;
  --border-bright: #2a3545;
  --text: #c5cdd8;
  --text-dim: #5c6978;
  --text-bright: #e8ecf1;
  --accent: #3ddc84;
  --accent-dim: rgba(61, 220, 132, 0.15);
  --danger: #e05252;
  --warn: #f0c040;

  --phase-1: #e05252;
  --phase-2: #34d1bf;
  --phase-3: #3ddc84;
  --phase-4: #4dd0e1;
  --phase-5: #e8b84d;
  --phase-6: #f06292;
  --phase-7: #42a5f5;
  --phase-8: #3ddc84;

  --body: 'Atkinson Hyperlegible Next', sans-serif;
  --mono: 'Atkinson Hyperlegible Mono', monospace;

  --panel-width: 380px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--body);
  overflow: hidden;
  height: 100vh;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    radial-gradient(circle at 20% 50%, rgba(91, 156, 246, 0.03) 0%, transparent 50%),
    radial-gradient(circle at 80% 30%, rgba(61, 220, 132, 0.03) 0%, transparent 50%),
    radial-gradient(circle, rgba(200, 200, 220, 0.02) 1px, transparent 1px);
  background-size: 100% 100%, 100% 100%, 24px 24px;
  pointer-events: none;
  z-index: 0;
}

/* ── Layout ────────────────────────────────── */
.layout {
  display: grid;
  grid-template-columns: 280px 1fr var(--panel-width);
  height: 100vh;
  position: relative;
  z-index: 1;
  transition: grid-template-columns 0.3s ease;
}

.layout.panel-collapsed {
  grid-template-columns: 280px 1fr 0px;
}

/* ── Sidebar ───────────────────────────────── */
.sidebar {
  background: var(--bg-panel);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--border) var(--bg-panel);
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  padding: 20px;
  border-bottom: 1px solid var(--border);
}

.sidebar-title {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 600;
  color: var(--text-bright);
  letter-spacing: 0.02em;
}

.sidebar-subtitle {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 4px;
  letter-spacing: 0.05em;
  text-transform: uppercase;
}

.status-badge {
  display: inline-block;
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 500;
  padding: 3px 8px;
  border-radius: 2px;
  margin-top: 8px;
  letter-spacing: 0.05em;
}

.status-badge.complete {
  color: var(--accent);
  background: var(--accent-dim);
  border: 1px solid rgba(61, 220, 132, 0.25);
}

.status-badge.incomplete {
  color: var(--warn);
  background: rgba(240, 192, 64, 0.15);
  border: 1px solid rgba(240, 192, 64, 0.25);
}

/* Metrics */
.metrics {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1px;
  background: var(--border);
  border-bottom: 1px solid var(--border);
}

.metric {
  background: var(--bg-panel);
  padding: 10px 12px;
  text-align: center;
}

.metric-value {
  font-family: var(--mono);
  font-size: 18px;
  font-weight: 600;
  color: var(--text-bright);
}

.metric-label {
  font-size: 9px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-top: 1px;
}

.metric-value.pass { color: var(--accent); }
.metric-value.warn { color: var(--warn); }

/* Gate timeline */
.section-label {
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 500;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 14px 20px 6px;
}

.gate-list {
  list-style: none;
  padding: 0 20px 12px;
  flex: 1;
  overflow-y: auto;
}

.gate-item {
  position: relative;
  padding: 8px 0 8px 24px;
  border-left: 2px solid var(--border);
  margin-left: 6px;
  cursor: pointer;
  transition: background 0.15s;
}

.gate-item:hover { background: var(--bg-hover); margin: 0 -20px; padding-left: 44px; padding-right: 20px; }
.gate-item:last-child { border-left-color: transparent; }

.gate-item::before {
  content: '';
  position: absolute;
  left: -7px;
  top: 12px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid var(--border);
  background: var(--bg-panel);
  transition: all 0.2s;
}

.gate-item.satisfied::before {
  border-color: var(--accent);
  background: var(--accent);
  box-shadow: 0 0 8px rgba(61, 220, 132, 0.3);
}

.gate-item .gate-phase {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-dim);
  letter-spacing: 0.05em;
}

.gate-item .gate-name {
  font-size: 12px;
  font-weight: 500;
  color: var(--text-bright);
  margin-top: 1px;
}

.gate-item .gate-desc {
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 1px;
}

.gate-item .gate-count {
  font-family: var(--mono);
  font-size: 9px;
  color: var(--text-dim);
  margin-top: 2px;
}

/* Legend */
.legend { padding: 0 20px 16px; }

.legend-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 10px;
  color: var(--text-dim);
}

.legend-swatch {
  width: 8px;
  height: 8px;
  border-radius: 2px;
  flex-shrink: 0;
}

/* Nav */
.nav-links {
  padding: 10px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 16px;
}

.nav-links a {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-dim);
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: all 0.2s;
}

.nav-links a:hover {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

/* ── Graph area ────────────────────────────── */
.graph-container {
  position: relative;
  overflow: hidden;
}

.graph-container svg { width: 100%; height: 100%; }

.phase-label {
  font-family: var(--mono);
  font-size: 10px;
  fill: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  opacity: 0.5;
}

.edge {
  stroke: var(--border);
  stroke-width: 1;
  fill: none;
  opacity: 0.4;
  transition: opacity 0.2s, stroke 0.2s;
}

.edge.highlighted { stroke: var(--accent); stroke-width: 1.5; opacity: 0.8; }
.edge.faded { opacity: 0.08; }

.edge.critical {
  stroke: var(--accent);
  stroke-width: 2;
  opacity: 0.7;
  stroke-dasharray: 6 3;
  animation: dash-flow 1.5s linear infinite;
}

@keyframes dash-flow { to { stroke-dashoffset: -18; } }

.node.critical circle { filter: drop-shadow(0 0 6px var(--accent)); }
.node { cursor: pointer; }

.node circle {
  stroke-width: 2;
  transition: r 0.2s, stroke-width 0.2s;
}

.node.faded circle { opacity: 0.15; }
.node.faded text { opacity: 0.1; }
.node.planned circle { stroke-dasharray: 4 3; opacity: 0.5; }
.node.planned text { opacity: 0.4; }

.node text {
  font-family: var(--mono);
  font-size: 8px;
  fill: var(--text);
  text-anchor: middle;
  pointer-events: none;
  transition: opacity 0.2s;
}

.node:hover circle {
  stroke-width: 3;
  filter: drop-shadow(0 0 6px currentColor);
}

/* Tooltip */
.tooltip {
  position: absolute;
  background: var(--bg-panel);
  border: 1px solid var(--border-bright);
  border-radius: 4px;
  padding: 12px 16px;
  font-size: 12px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s;
  max-width: 300px;
  z-index: 10;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}

.tooltip.visible { opacity: 1; }

.tooltip-name {
  font-family: var(--mono);
  font-weight: 600;
  color: var(--text-bright);
  font-size: 13px;
}

.tooltip-type { font-family: var(--mono); font-size: 10px; margin-top: 4px; }
.tooltip-type span { display: inline-block; padding: 1px 6px; border-radius: 2px; margin-right: 4px; }
.tooltip-desc { color: var(--text-dim); margin-top: 6px; line-height: 1.5; }

.tooltip-meta {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 6px;
  padding-top: 6px;
  border-top: 1px solid var(--border);
}

marker path { fill: var(--border); }
marker.highlighted path { fill: var(--accent); }

/* Panel toggle button */
.panel-toggle {
  position: absolute;
  right: var(--panel-width);
  top: 50%;
  transform: translateY(-50%);
  z-index: 5;
  width: 24px;
  height: 48px;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-right: none;
  border-radius: 4px 0 0 4px;
  color: var(--text-dim);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  transition: right 0.3s ease, color 0.2s;
}

.panel-toggle:hover { color: var(--accent); }
.layout.panel-collapsed .panel-toggle { right: 0; }

/* ── Right Panel ───────────────────────────── */
.right-panel {
  background: var(--bg-panel);
  border-left: 1px solid var(--border);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  transition: width 0.3s ease;
}

.layout.panel-collapsed .right-panel { border-left: none; }

/* Tab strip */
.tab-strip {
  display: flex;
  flex-wrap: wrap;
  gap: 2px;
  padding: 10px 10px 0;
  border-bottom: 1px solid var(--border);
  background: var(--bg);
}

.tab-btn {
  font-family: var(--mono);
  font-size: 10px;
  padding: 6px 10px;
  background: transparent;
  border: 1px solid transparent;
  border-bottom: none;
  border-radius: 3px 3px 0 0;
  color: var(--text-dim);
  cursor: pointer;
  letter-spacing: 0.03em;
  transition: all 0.15s;
  white-space: nowrap;
}

.tab-btn:hover { color: var(--text-bright); background: var(--bg-hover); }

.tab-btn.active {
  color: var(--text-bright);
  background: var(--bg-panel);
  border-color: var(--border);
}

.tab-btn .tab-dot {
  display: inline-block;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  margin-right: 5px;
  vertical-align: middle;
}

/* Tab content */
.tab-content {
  flex: 1;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--border) var(--bg-panel);
}

.tab-pane {
  display: none;
  padding: 16px;
  animation: fadeIn 0.2s ease;
}

.tab-pane.active { display: block; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

/* ── Tab shared styles ─────────────────────── */
.panel-section {
  margin-bottom: 16px;
}

.panel-section-title {
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 500;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 8px;
}

/* Credential badge */
.vc-badge {
  background: linear-gradient(135deg, #121820 0%, #0f1319 100%);
  border: 1px solid var(--border-bright);
  border-radius: 6px;
  padding: 16px;
  position: relative;
  overflow: hidden;
}

.vc-badge::before {
  content: '';
  position: absolute;
  top: -20px;
  right: -20px;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 2px solid rgba(61, 220, 132, 0.1);
}

.vc-badge::after {
  content: '';
  position: absolute;
  top: -10px;
  right: -10px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 2px solid rgba(61, 220, 132, 0.06);
}

.vc-stamp {
  position: absolute;
  top: 12px;
  right: 16px;
  font-family: var(--mono);
  font-size: 28px;
  font-weight: 800;
  color: rgba(61, 220, 132, 0.12);
  transform: rotate(12deg);
  letter-spacing: 0.05em;
}

.vc-type {
  font-family: var(--mono);
  font-size: 9px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.vc-title {
  font-family: var(--mono);
  font-size: 14px;
  font-weight: 600;
  color: var(--text-bright);
  margin-top: 4px;
}

.vc-field {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 6px;
}

.vc-field span { color: var(--text); }

/* Rule rows */
.rule-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
  font-size: 11px;
}

.rule-row:last-child { border-bottom: none; }

.rule-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.rule-dot.pass { background: var(--accent); box-shadow: 0 0 4px rgba(61, 220, 132, 0.4); }
.rule-dot.fail { background: var(--danger); box-shadow: 0 0 4px rgba(224, 82, 82, 0.4); }

.rule-name { font-family: var(--mono); font-size: 10px; color: var(--text-bright); flex: 1; }
.rule-severity { font-family: var(--mono); font-size: 9px; color: var(--text-dim); text-transform: uppercase; }

/* Mini metrics row */
.mini-metrics {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1px;
  background: var(--border);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 12px;
}

.mini-metric {
  background: var(--bg-card);
  padding: 8px 4px;
  text-align: center;
}

.mini-metric-value {
  font-family: var(--mono);
  font-size: 16px;
  font-weight: 600;
  color: var(--text-bright);
}

.mini-metric-label {
  font-size: 8px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-top: 1px;
}

/* Gantt chart */
.gantt-container {
  position: relative;
  overflow-x: hidden;
  overflow-y: auto;
  max-height: 320px;
  scrollbar-width: thin;
  scrollbar-color: var(--border) var(--bg-panel);
}

.gantt-container svg {
  display: block;
}

/* Slack histogram */
.histogram-container {
  height: 60px;
  margin-top: 8px;
}

/* Policy matrix */
.policy-matrix {
  width: 100%;
  border-collapse: collapse;
  font-family: var(--mono);
  font-size: 10px;
}

.policy-matrix th {
  text-align: left;
  padding: 6px 8px;
  color: var(--text-dim);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-bottom: 1px solid var(--border);
  font-size: 9px;
}

.policy-matrix td {
  padding: 6px 8px;
  border-bottom: 1px solid var(--border);
  color: var(--text);
  vertical-align: top;
  font-size: 10px;
  line-height: 1.4;
}

.policy-matrix tr:last-child td { border-bottom: none; }
.policy-matrix .col-label { color: var(--text-dim); font-weight: 500; width: 80px; }

.classification-badge {
  font-family: var(--mono);
  font-size: 9px;
  padding: 2px 6px;
  border-radius: 2px;
  font-weight: 500;
  letter-spacing: 0.03em;
}

.classification-badge.unclass { color: var(--accent); background: rgba(61, 220, 132, 0.1); border: 1px solid rgba(61, 220, 132, 0.2); }
.classification-badge.prot-a { color: var(--warn); background: rgba(240, 192, 64, 0.1); border: 1px solid rgba(240, 192, 64, 0.2); }
.classification-badge.prot-b { color: var(--danger); background: rgba(224, 82, 82, 0.1); border: 1px solid rgba(224, 82, 82, 0.2); }

/* Provenance chain */
.prov-chain {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.prov-node {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 8px 10px;
  border-radius: 4px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  cursor: default;
  transition: border-color 0.2s;
}

.prov-node:hover { border-color: var(--border-bright); }

.prov-icon {
  width: 24px;
  height: 24px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  flex-shrink: 0;
  font-weight: 600;
}

.prov-icon.agent { background: rgba(124, 87, 194, 0.15); color: #7e57c2; }
.prov-icon.activity { background: rgba(66, 165, 245, 0.15); color: #42a5f5; }
.prov-icon.source { background: rgba(161, 136, 127, 0.15); color: #a1887f; }
.prov-icon.fact { background: rgba(129, 199, 132, 0.15); color: #81c784; }

.prov-title {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-bright);
  font-weight: 500;
}

.prov-detail {
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 1px;
  line-height: 1.3;
}

.prov-arrow {
  text-align: center;
  color: var(--text-dim);
  font-size: 11px;
  padding: 0 0 0 12px;
  opacity: 0.4;
}

/* Fact/source table */
.fact-table {
  width: 100%;
  border-collapse: collapse;
}

.fact-table td {
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
  vertical-align: top;
  font-size: 11px;
  line-height: 1.4;
}

.fact-table tr:last-child td { border-bottom: none; }

.fact-id {
  font-family: var(--mono);
  font-size: 9px;
  color: var(--text-dim);
  width: 56px;
}

.fact-claim { color: var(--text); }

.fact-meta {
  font-family: var(--mono);
  font-size: 9px;
  color: var(--text-dim);
  margin-top: 2px;
}

.confidence-badge {
  font-family: var(--mono);
  font-size: 8px;
  padding: 1px 4px;
  border-radius: 2px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.confidence-badge.verified { color: var(--accent); background: rgba(61, 220, 132, 0.1); }
.confidence-badge.derived { color: var(--warn); background: rgba(240, 192, 64, 0.1); }

/* Catalog cards */
.catalog-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 12px;
  margin-bottom: 8px;
  transition: border-color 0.2s;
}

.catalog-card:hover { border-color: var(--border-bright); }

.catalog-title {
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--text-bright);
}

.catalog-keywords {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-top: 6px;
}

.catalog-keyword {
  font-family: var(--mono);
  font-size: 9px;
  color: var(--text-dim);
  background: var(--bg);
  padding: 2px 6px;
  border-radius: 2px;
  border: 1px solid var(--border);
}

.catalog-conformance {
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 6px;
  line-height: 1.4;
}

.catalog-conformance a {
  color: var(--accent);
  text-decoration: none;
  font-family: var(--mono);
  font-size: 10px;
}

.catalog-conformance a:hover { text-decoration: underline; }

/* SKOS glossary */
.glossary-group {
  margin-bottom: 12px;
}

.glossary-group-title {
  font-family: var(--mono);
  font-size: 9px;
  font-weight: 500;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 4px;
  padding-left: 2px;
}

.glossary-item {
  padding: 4px 8px;
  border-radius: 3px;
  transition: background 0.15s;
  cursor: default;
}

.glossary-item:hover { background: var(--bg-hover); }

.glossary-term {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  color: var(--text-bright);
}

.glossary-def {
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 1px;
}

/* Sub-tab toggle */
.sub-tabs {
  display: flex;
  gap: 2px;
  margin-bottom: 10px;
  background: var(--bg);
  border-radius: 4px;
  padding: 2px;
}

.sub-tab {
  font-family: var(--mono);
  font-size: 10px;
  padding: 5px 10px;
  background: transparent;
  border: none;
  border-radius: 3px;
  color: var(--text-dim);
  cursor: pointer;
  flex: 1;
  text-align: center;
  transition: all 0.15s;
}

.sub-tab:hover { color: var(--text-bright); }
.sub-tab.active { color: var(--text-bright); background: var(--bg-panel); }

/* Big conforms badge */
.conforms-badge {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 14px;
  border-radius: 6px;
  margin-bottom: 12px;
}

.conforms-badge.pass {
  background: rgba(61, 220, 132, 0.06);
  border: 1px solid rgba(61, 220, 132, 0.15);
}

.conforms-badge.fail {
  background: rgba(224, 82, 82, 0.06);
  border: 1px solid rgba(224, 82, 82, 0.15);
}

.conforms-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.conforms-badge.pass .conforms-icon { background: rgba(61, 220, 132, 0.15); color: var(--accent); }
.conforms-badge.fail .conforms-icon { background: rgba(224, 82, 82, 0.15); color: var(--danger); }

.conforms-text {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 600;
}

.conforms-badge.pass .conforms-text { color: var(--accent); }
.conforms-badge.fail .conforms-text { color: var(--danger); }

.conforms-sub {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 1px;
}

/* Node highlight ring (for tab→graph interaction) */
.node-highlight-ring {
  fill: none;
  stroke: var(--accent);
  stroke-width: 2;
  opacity: 0;
  transition: opacity 0.3s;
}

.node-highlight-ring.active {
  opacity: 1;
  animation: pulse-ring 1.5s ease infinite;
}

@keyframes pulse-ring {
  0%, 100% { r: 16; opacity: 0.6; }
  50% { r: 22; opacity: 0; }
}
</style>
</head>
<body>
<div class="layout" id="layout">

<!-- ═══ SIDEBAR ════════════════════════════════════════════ -->
<aside class="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-title">GC LLM Governance</div>
    <div class="sidebar-subtitle">Constraint-First &middot; W3C Projections</div>
    <div id="status-badge"></div>
  </div>

  <div class="metrics" id="metrics"></div>

  <div class="section-label">Phase Gates</div>
  <ul class="gate-list" id="gate-list"></ul>

  <div class="section-label">Types</div>
  <div class="legend" id="legend"></div>

  <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="charter.html">Build Charter</a>
  </div>
</aside>

<!-- ═══ GRAPH ═════════════════════════════════════════════ -->
<div class="graph-container" id="graph-area">
  <svg id="graph-svg"></svg>
  <div class="tooltip" id="tooltip"></div>
</div>

<!-- ═══ PANEL TOGGLE ═══════════════════════════════════════ -->
<button class="panel-toggle" id="panel-toggle" title="Toggle projection panel">&#x25B6;</button>

<!-- ═══ RIGHT PANEL — W3C PROJECTIONS ═════════════════════ -->
<div class="right-panel">
  <div class="tab-strip" id="tab-strip">
    <button class="tab-btn active" data-tab="compliance">
      <span class="tab-dot" style="background:var(--accent)"></span>Comply</button>
    <button class="tab-btn" data-tab="schedule">
      <span class="tab-dot" style="background:var(--phase-7)"></span>Schedule</button>
    <button class="tab-btn" data-tab="policies">
      <span class="tab-dot" style="background:var(--phase-5)"></span>Policies</button>
    <button class="tab-btn" data-tab="provenance">
      <span class="tab-dot" style="background:#7e57c2"></span>Prov</button>
    <button class="tab-btn" data-tab="knowledge">
      <span class="tab-dot" style="background:var(--phase-4)"></span>Facts</button>
    <button class="tab-btn" data-tab="catalog">
      <span class="tab-dot" style="background:#8d6e63"></span>Catalog</button>
    <button class="tab-btn" data-tab="vocabulary">
      <span class="tab-dot" style="background:#c084fc"></span>Vocab</button>
  </div>
  <div class="tab-content" id="tab-content">
    <div class="tab-pane active" id="pane-compliance"></div>
    <div class="tab-pane" id="pane-schedule"></div>
    <div class="tab-pane" id="pane-policies"></div>
    <div class="tab-pane" id="pane-provenance"></div>
    <div class="tab-pane" id="pane-knowledge"></div>
    <div class="tab-pane" id="pane-catalog"></div>
    <div class="tab-pane" id="pane-vocabulary"></div>
  </div>
</div>

</div>

<script>
const DATA_URL = 'data/gc-llm-governance.json';
const PROJ_URL = 'data/gc-llm-governance-projections.json';

const PHASE_COLORS = {
  1: '#e05252', 2: '#34d1bf', 3: '#3ddc84',
  4: '#4dd0e1', 5: '#e8b84d', 6: '#f06292',
  7: '#42a5f5', 8: '#3ddc84'
};

const PHASE_NAMES = {
  1: 'Obligation Graph', 2: 'Impact Levels + Controls', 3: 'Compliance Rules',
  4: 'Knowledge Grounding', 5: 'ODRL Policies + Providers', 6: 'Deployment Models',
  7: 'Audit + Provenance', 8: 'Compliance Reporting'
};

const TYPE_COLORS = {
  Framework:'#5b9cf6', Statute:'#e05252', Directive:'#f09070', Guide:'#f0c040',
  SecurityGuidance:'#ff8c42', Principle:'#c084fc', ImpactLevel:'#7b6cf6',
  ControlObjective:'#34d1bf', ComplianceRule:'#3ddc84', PolicyConstraint:'#e8b84d',
  LLMProvider:'#5b9cf6', LLMDeployment:'#f06292', DomainScope:'#4dd0e1',
  PolicyFact:'#81c784', AuthoritativeSource:'#a1887f', TermDefinition:'#90a4ae',
  ClassificationGate:'#ff7043', BilingualGate:'#26c6da', HumanReviewGate:'#ab47bc',
  AuditSink:'#66bb6a', SmokeTest:'#42a5f5', ComplianceReport:'#3ddc84',
  VerifiableCredential:'#7e57c2', CatalogEntry:'#8d6e63', Schedule:'#78909c'
};

const LEGEND_CATEGORIES = {
  Obligation:'#e05252', Control:'#34d1bf', Rule:'#3ddc84', Knowledge:'#4dd0e1',
  Policy:'#e8b84d', Deployment:'#f06292', Audit:'#42a5f5', Reporting:'#3ddc84'
};

// SKOS type → legend group mapping
const TYPE_GROUPS = {
  Obligation: ['Framework','Statute','Directive','Guide','SecurityGuidance','Principle'],
  Control: ['ImpactLevel','ControlObjective'],
  Rule: ['ComplianceRule'],
  Knowledge: ['DomainScope','PolicyFact','AuthoritativeSource','TermDefinition'],
  Policy: ['PolicyConstraint','LLMProvider'],
  Deployment: ['LLMDeployment','ClassificationGate','BilingualGate','HumanReviewGate'],
  Audit: ['AuditSink','SmokeTest'],
  Reporting: ['ComplianceReport','VerifiableCredential','CatalogEntry','Schedule']
};

function primaryType(types) {
  const order = [
    'Statute','Directive','Guide','ComplianceRule','ControlObjective',
    'LLMDeployment','PolicyConstraint','LLMProvider','AuditSink',
    'SmokeTest','ComplianceReport','VerifiableCredential','Framework',
    'SecurityGuidance','Principle','ImpactLevel','DomainScope',
    'PolicyFact','AuthoritativeSource','TermDefinition',
    'ClassificationGate','BilingualGate','HumanReviewGate',
    'CatalogEntry','Schedule'
  ];
  for (const t of order) if (types.includes(t)) return t;
  return types[0] || 'Framework';
}

// ═══ State ════════════════════════════════════
let graphData, projData;
let nodeElements, edgeElements;
const rendered = {};

// ═══ Init ═════════════════════════════════════
async function init() {
  try {
    [graphData, projData] = await Promise.all([
      fetch(DATA_URL).then(r => r.json()),
      fetch(PROJ_URL).then(r => r.json())
    ]);
  } catch(e) {
    console.error('Failed to load data:', e);
    return;
  }

  window.nodeMap = {};
  graphData.nodes.forEach(n => { nodeMap[n.id] = n; });

  window.criticalSet = new Set();
  if (graphData.scheduling && graphData.scheduling.critical_sequence) {
    graphData.scheduling.critical_sequence.forEach(s => criticalSet.add(s.resource));
  }

  renderSidebar(graphData);
  renderGraph(graphData);
  setupTabs();
  setupPanelToggle();

  // Render initial tab
  renderTab('compliance');

  // Handle hash routing
  const hash = location.hash.replace('#', '');
  if (hash && document.getElementById('pane-' + hash)) {
    switchTab(hash);
  }
}

// ═══ Panel toggle ════════════════════════════
function setupPanelToggle() {
  const btn = document.getElementById('panel-toggle');
  const layout = document.getElementById('layout');
  btn.addEventListener('click', () => {
    layout.classList.toggle('panel-collapsed');
    btn.innerHTML = layout.classList.contains('panel-collapsed') ? '&#x25C0;' : '&#x25B6;';
  });
}

// ═══ Tab management ══════════════════════════
function setupTabs() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => switchTab(btn.dataset.tab));
  });
}

function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === name));
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.toggle('active', p.id === 'pane-' + name));
  location.hash = name;
  renderTab(name);
}

function renderTab(name) {
  if (rendered[name]) return;
  rendered[name] = true;

  const renderers = {
    compliance: renderCompliance,
    schedule: renderSchedule,
    policies: renderPolicies,
    provenance: renderProvenance,
    knowledge: renderKnowledge,
    catalog: renderCatalog,
    vocabulary: renderVocabulary
  };

  if (renderers[name]) renderers[name]();
}

// ═══ Sidebar ═════════════════════════════════
function renderSidebar(data) {
  const badge = document.getElementById('status-badge');
  const complete = data.charter_summary.complete;
  const nextGate = data.charter_summary.next_gate;
  badge.innerHTML = `<span class="status-badge ${complete ? 'complete' : 'incomplete'}">${
    complete ? 'ALL GATES SATISFIED' : `NEXT: ${nextGate}`
  }</span>`;

  const m = document.getElementById('metrics');
  const totalResources = data.charter_summary.total_resources || data.nodes.length;
  const totalGates = Object.keys(data.gates).length;
  const satisfiedGates = Object.values(data.gates).filter(g => g.satisfied).length;
  const cpmSummary = data.scheduling && data.scheduling.summary;
  const compliance = data.charter_summary.compliance;

  const metrics = [
    [totalResources, 'Resources', ''],
    [`${satisfiedGates}/${totalGates}`, 'Gates', satisfiedGates === totalGates ? 'pass' : 'warn'],
    [compliance ? `${compliance.passed}/${compliance.total}` : '—', 'Rules', compliance && compliance.failed === 0 ? 'pass' : 'warn'],
    [cpmSummary ? cpmSummary.critical_count : '—', 'Critical Path', ''],
    [cpmSummary ? cpmSummary.total_duration + 'd' : '—', 'Duration', ''],
    [data.charter_summary.single_points_of_failure ? data.charter_summary.single_points_of_failure.spof_count : '—', 'SPOF', 'warn'],
  ];

  m.innerHTML = metrics.map(([v, l, cls]) =>
    `<div class="metric"><div class="metric-value ${cls}">${v}</div><div class="metric-label">${l}</div></div>`
  ).join('');

  // Gates
  const gl = document.getElementById('gate-list');
  const sortedGates = Object.entries(data.gates).sort((a,b) => a[1].phase - b[1].phase);
  gl.innerHTML = sortedGates.map(([name, gate]) => {
    const color = PHASE_COLORS[gate.phase] || '#5b9cf6';
    return `<li class="gate-item ${gate.satisfied ? 'satisfied' : ''}" data-gate="${name}">
      <div class="gate-phase" style="color:${color}">Phase ${gate.phase}</div>
      <div class="gate-name">${name}</div>
      <div class="gate-desc">${gate.description}</div>
      <div class="gate-count">${gate.resources.length} resources</div>
    </li>`;
  }).join('');

  gl.querySelectorAll('.gate-item').forEach(el => {
    el.addEventListener('mouseenter', () => {
      const resources = new Set(graphData.gates[el.dataset.gate].resources);
      highlightNodes(resources);
    });
    el.addEventListener('mouseleave', clearHighlight);
  });

  // Legend
  const lg = document.getElementById('legend');
  lg.innerHTML = '<div class="legend-grid">' +
    Object.entries(LEGEND_CATEGORIES).map(([t, c]) =>
      `<div class="legend-item"><span class="legend-swatch" style="background:${c}"></span>${t}</div>`
    ).join('') + '</div>';
}

// ═══ Graph highlight ═════════════════════════
function highlightNodes(nameSet) {
  if (!nodeElements) return;
  nodeElements.classed('faded', d => !nameSet.has(d.id));
  edgeElements.classed('faded', d => !nameSet.has(d.source.id || d.source) && !nameSet.has(d.target.id || d.target));
  edgeElements.classed('highlighted', d => nameSet.has(d.source.id || d.source) && nameSet.has(d.target.id || d.target));
}

function clearHighlight() {
  if (!nodeElements) return;
  nodeElements.classed('faded', false);
  edgeElements.classed('faded', false).classed('highlighted', false);
}

function highlightSingleNode(nodeId) {
  if (!nodeElements) return;
  nodeElements.each(function(d) {
    const ring = d3.select(this).select('.node-highlight-ring');
    ring.classed('active', d.id === nodeId);
  });
  // Auto-clear after 3s
  setTimeout(() => {
    nodeElements.selectAll('.node-highlight-ring').classed('active', false);
  }, 3000);
}

// ═══ Graph render ════════════════════════════
function renderGraph(data) {
  const container = document.getElementById('graph-area');
  const svg = d3.select('#graph-svg');
  const width = container.clientWidth;
  const height = container.clientHeight;

  svg.attr('viewBox', [0, 0, width, height]);

  svg.append('defs').append('marker')
    .attr('id', 'arrow')
    .attr('viewBox', '0 -4 8 8')
    .attr('refX', 16).attr('refY', 0)
    .attr('markerWidth', 6).attr('markerHeight', 6)
    .attr('orient', 'auto')
    .append('path').attr('d', 'M0,-3L7,0L0,3').attr('fill', '#2a3545');

  const g = svg.append('g');

  const zoom = d3.zoom()
    .scaleExtent([0.3, 4])
    .on('zoom', e => g.attr('transform', e.transform));
  svg.call(zoom);

  const maxDepth = Math.max(...data.nodes.map(n => n.depth));
  const marginY = 80;
  const layerH = (height - marginY * 2) / Math.max(maxDepth, 1);

  const depthGroups = {};
  data.nodes.forEach(n => {
    if (!depthGroups[n.depth]) depthGroups[n.depth] = [];
    depthGroups[n.depth].push(n);
  });

  const phaseDepthRanges = {};
  data.nodes.forEach(n => {
    if (!phaseDepthRanges[n.phase]) phaseDepthRanges[n.phase] = [Infinity, -Infinity];
    phaseDepthRanges[n.phase][0] = Math.min(phaseDepthRanges[n.phase][0], n.depth);
    phaseDepthRanges[n.phase][1] = Math.max(phaseDepthRanges[n.phase][1], n.depth);
  });

  Object.entries(phaseDepthRanges).forEach(([phase, [minD, maxD]]) => {
    const y1 = marginY + minD * layerH - layerH * 0.4;
    const y2 = marginY + maxD * layerH + layerH * 0.4;
    const color = PHASE_COLORS[phase] || '#5b9cf6';
    g.append('rect')
      .attr('x', 20).attr('y', y1)
      .attr('width', width - 40).attr('height', y2 - y1)
      .attr('rx', 4)
      .attr('fill', color).attr('opacity', 0.02);
    g.append('text')
      .attr('class', 'phase-label')
      .attr('x', 32).attr('y', y1 + 14)
      .attr('fill', color)
      .text(`Phase ${phase} — ${PHASE_NAMES[phase] || ''}`);
  });

  data.nodes.forEach(n => {
    const group = depthGroups[n.depth];
    const idx = group.indexOf(n);
    const count = group.length;
    const spacing = Math.min((width - 80) / (count + 1), 140);
    const startX = (width - (count - 1) * spacing) / 2;
    n.x = startX + idx * spacing;
    n.y = marginY + n.depth * layerH;
  });

  const nodeById = {};
  data.nodes.forEach(n => { nodeById[n.id] = n; });
  data.edges.forEach(e => {
    if (typeof e.source === 'string') e.source = nodeById[e.source];
    if (typeof e.target === 'string') e.target = nodeById[e.target];
  });

  edgeElements = g.append('g')
    .selectAll('path').data(data.edges).join('path')
    .attr('class', d => {
      const s = d.source.id || d.source;
      const t = d.target.id || d.target;
      return 'edge' + (criticalSet.has(s) && criticalSet.has(t) ? ' critical' : '');
    })
    .attr('marker-end', 'url(#arrow)')
    .attr('d', d => {
      const dx = d.target.x - d.source.x;
      const dy = d.target.y - d.source.y;
      const cx = d.source.x + dx * 0.5;
      const cy1 = d.source.y + dy * 0.3;
      const cy2 = d.source.y + dy * 0.7;
      return `M${d.source.x},${d.source.y} C${cx},${cy1} ${cx},${cy2} ${d.target.x},${d.target.y}`;
    });

  nodeElements = g.append('g')
    .selectAll('g').data(data.nodes).join('g')
    .attr('class', d => 'node' + (d.planned ? ' planned' : '') + (criticalSet.has(d.id) ? ' critical' : ''));

  // Highlight ring (for tab→graph interaction)
  nodeElements.append('circle')
    .attr('class', 'node-highlight-ring')
    .attr('r', 18);

  nodeElements.append('circle')
    .attr('r', d => d.depth === 0 ? 14 : d.types.length > 1 ? 11 : 9)
    .attr('fill', d => {
      const color = PHASE_COLORS[d.phase] || '#5b9cf6';
      return d.planned ? 'transparent' : color + '20';
    })
    .attr('stroke', d => TYPE_COLORS[primaryType(d.types)] || '#5b9cf6')
    .style('color', d => TYPE_COLORS[primaryType(d.types)] || '#5b9cf6');

  nodeElements.append('text')
    .attr('dy', d => (d.depth === 0 ? 14 : d.types.length > 1 ? 11 : 9) + 14)
    .text(d => d.name.length > 20 ? d.name.substring(0, 18) + '...' : d.name);

  // Tooltip
  const tooltip = document.getElementById('tooltip');
  nodeElements.on('mouseenter', (e, d) => {
    const typeSpans = d.types.map(t => {
      const c = TYPE_COLORS[t] || '#5b9cf6';
      return `<span style="background:${c}20;color:${c};border:1px solid ${c}40">${t}</span>`;
    }).join('');

    // OWL-Time scheduling data from projections
    const owlEntry = projData && projData.owl_time ? projData.owl_time[d.id] : null;
    let schedulingHtml = '';
    if (owlEntry) {
      const es = owlEntry['time:hasBeginning']['time:inXSDDecimal'];
      const ef = owlEntry['time:hasEnd']['time:inXSDDecimal'];
      const dur = owlEntry['time:hasDuration']['time:numericDuration'];
      const slack = owlEntry['apercue:slack'];
      const isCrit = owlEntry['apercue:isCritical'];
      const ls = es + slack;
      const lf = ef + slack;
      const slackLabel = isCrit
        ? '<span style="color:var(--accent)">CRITICAL</span>'
        : `Slack ${slack}`;
      schedulingHtml = `<div class="tooltip-meta">
        ES ${es} &rarr; EF ${ef} &middot; LS ${ls} &rarr; LF ${lf} &middot; ${slackLabel}
      </div>`;
    }

    const gateLabel = d.gate ? ` &middot; ${d.gate}` : '';
    tooltip.innerHTML = `
      <div class="tooltip-name">${d.name}</div>
      <div class="tooltip-type">${typeSpans}</div>
      ${d.description ? `<div class="tooltip-desc">${d.description}</div>` : ''}
      <div class="tooltip-meta">
        Phase ${d.phase}${gateLabel} &middot; Depth ${d.depth}
      </div>${schedulingHtml}`;
    tooltip.classList.add('visible');

    const connected = new Set([d.id]);
    graphData.edges.forEach(edge => {
      const s = edge.source.id || edge.source;
      const t = edge.target.id || edge.target;
      if (s === d.id) connected.add(t);
      if (t === d.id) connected.add(s);
    });
    highlightNodes(connected);
  })
  .on('mousemove', e => {
    const rect = document.getElementById('graph-area').getBoundingClientRect();
    tooltip.style.left = (e.clientX - rect.left + 16) + 'px';
    tooltip.style.top = (e.clientY - rect.top - 10) + 'px';
  })
  .on('mouseleave', () => {
    tooltip.classList.remove('visible');
    clearHighlight();
  })
  .on('click', (e, d) => {
    // Click node → open relevant tab
    const type = primaryType(d.types);
    if (['ComplianceRule','ComplianceReport'].includes(type)) switchTab('compliance');
    else if (['Schedule'].includes(type)) switchTab('schedule');
    else if (['PolicyConstraint','LLMProvider'].includes(type)) switchTab('policies');
    else if (['PolicyFact','AuthoritativeSource','TermDefinition'].includes(type)) switchTab('knowledge');
    else if (['CatalogEntry','LLMDeployment'].includes(type)) switchTab('catalog');
    else if (['AuditSink','SmokeTest'].includes(type)) switchTab('provenance');
  });

  nodeElements.attr('transform', d => `translate(${d.x},${d.y})`);
}

// ═══ Tab 1: Compliance (SHACL + VC) ══════════
function renderCompliance() {
  const pane = document.getElementById('pane-compliance');
  const shacl = projData.shacl;
  const vc = projData.vc;
  const conforms = shacl['sh:conforms'];
  const results = shacl['sh:result'] || [];
  const compliance = graphData.charter_summary.compliance;

  let html = '';

  // Conforms badge
  html += `<div class="conforms-badge ${conforms ? 'pass' : 'fail'}">
    <div class="conforms-icon">${conforms ? '&#10003;' : '&#10007;'}</div>
    <div>
      <div class="conforms-text">${conforms ? 'CONFORMS' : 'VIOLATIONS FOUND'}</div>
      <div class="conforms-sub">sh:ValidationReport &middot; ${results.length} violation${results.length !== 1 ? 's' : ''}</div>
    </div>
  </div>`;

  // Compliance rules
  if (compliance) {
    html += `<div class="panel-section">
      <div class="panel-section-title">Structural Rules (${compliance.passed}/${compliance.total})</div>`;

    // Get rule names from graph data
    const ruleNames = [
      ['deployments-need-providers', 'Every LLM deployment depends on a provider', 'critical'],
      ['providers-need-policies', 'Every provider depends on a classification policy', 'critical'],
      ['rules-need-objectives', 'Every rule traces to a control objective', 'critical'],
      ['objectives-need-obligations', 'Every objective traces to a statute/directive', 'critical'],
      ['audit-needs-deployments', 'Audit sinks depend on deployed instances', 'critical'],
      ['reports-need-audit', 'Compliance reports depend on audit evidence', 'critical']
    ];

    ruleNames.forEach(([name, desc, severity]) => {
      html += `<div class="rule-row">
        <div class="rule-dot pass"></div>
        <div class="rule-name" title="${desc}">${name}</div>
        <div class="rule-severity">${severity}</div>
      </div>`;
    });

    html += '</div>';
  }

  // VC credential card
  html += `<div class="panel-section">
    <div class="panel-section-title">Verifiable Credential</div>
    <div class="vc-badge">
      <div class="vc-stamp">${conforms ? 'VALID' : 'FAIL'}</div>
      <div class="vc-type">W3C Verifiable Credential 2.0</div>
      <div class="vc-title">Compliance Attestation</div>
      <div class="vc-field">Issuer: <span>${vc.issuer}</span></div>
      <div class="vc-field">Valid from: <span>${vc.validFrom}</span></div>
      <div class="vc-field">Subject: <span>${vc.credentialSubject.id}</span></div>
      <div class="vc-field">Violations: <span>${vc.credentialSubject['apercue:violationCount']}</span></div>
    </div>
  </div>`;

  pane.innerHTML = html;
}

// ═══ Tab 2: Schedule (OWL-Time + CPM) ════════
function renderSchedule() {
  const pane = document.getElementById('pane-schedule');
  const sched = projData.scheduling;
  const owl = projData.owl_time;
  const spof = graphData.charter_summary.single_points_of_failure;

  let html = '';

  // Mini metrics
  html += `<div class="mini-metrics">
    <div class="mini-metric"><div class="mini-metric-value">${sched.summary.total_duration}d</div><div class="mini-metric-label">Duration</div></div>
    <div class="mini-metric"><div class="mini-metric-value">${sched.summary.critical_count}</div><div class="mini-metric-label">Critical</div></div>
    <div class="mini-metric"><div class="mini-metric-value">${sched.summary.max_slack}</div><div class="mini-metric-label">Max Slack</div></div>
    <div class="mini-metric"><div class="mini-metric-value">${spof ? spof.spof_count : '—'}</div><div class="mini-metric-label">SPOF</div></div>
  </div>`;

  // Gantt chart
  html += `<div class="panel-section">
    <div class="panel-section-title">Gantt — OWL-Time Intervals</div>
    <div class="gantt-container" id="gantt-container"></div>
  </div>`;

  // Slack histogram
  html += `<div class="panel-section">
    <div class="panel-section-title">Slack Distribution</div>
    <div class="histogram-container" id="histogram-container"></div>
  </div>`;

  // Critical path sequence
  html += `<div class="panel-section">
    <div class="panel-section-title">Critical Path (${sched.critical_sequence.length} nodes)</div>`;
  sched.critical_sequence.forEach((s, i) => {
    html += `<div class="rule-row" style="cursor:pointer" data-node="${s.resource}">
      <div class="rule-dot pass"></div>
      <div class="rule-name">${s.resource}</div>
      <div class="rule-severity">${i + 1}</div>
    </div>`;
  });
  html += '</div>';

  pane.innerHTML = html;

  // Render D3 Gantt
  renderGantt(owl, sched);
  renderHistogram(owl);

  // Click critical path nodes → highlight graph
  pane.querySelectorAll('[data-node]').forEach(el => {
    el.addEventListener('click', () => highlightSingleNode(el.dataset.node));
    el.addEventListener('mouseenter', () => highlightNodes(new Set([el.dataset.node])));
    el.addEventListener('mouseleave', clearHighlight);
  });
}

function renderGantt(owl, sched) {
  const container = document.getElementById('gantt-container');
  if (!container) return;

  // Build entries from OWL-Time
  const entries = [];
  for (const [name, val] of Object.entries(owl)) {
    if (name === '@context') continue;
    const es = val['time:hasBeginning']['time:inXSDDecimal'];
    const ef = val['time:hasEnd']['time:inXSDDecimal'];
    const slack = val['apercue:slack'];
    const isCrit = val['apercue:isCritical'];
    const node = nodeMap[name];
    const phase = node ? node.phase : 0;
    entries.push({ name, es, ef, slack, isCrit, phase });
  }

  // Sort by earliest start, then name
  entries.sort((a, b) => a.es - b.es || a.name.localeCompare(b.name));

  const barH = 12;
  const gap = 2;
  const rowH = barH + gap;
  const labelW = 0; // no labels in compact view
  const chartW = container.clientWidth || 340;
  const chartH = entries.length * rowH + 4;
  const maxTime = Math.max(...entries.map(e => e.ef + e.slack));

  const xScale = d3.scaleLinear().domain([0, maxTime]).range([4, chartW - 4]);

  const svg = d3.select(container).append('svg')
    .attr('width', chartW).attr('height', chartH);

  // Time grid
  for (let t = 0; t <= maxTime; t++) {
    svg.append('line')
      .attr('x1', xScale(t)).attr('y1', 0)
      .attr('x2', xScale(t)).attr('y2', chartH)
      .attr('stroke', '#1e2733').attr('stroke-width', 0.5);
  }

  entries.forEach((e, i) => {
    const y = i * rowH + 2;
    const color = PHASE_COLORS[e.phase] || '#5b9cf6';

    // Slack bar (lighter)
    if (e.slack > 0) {
      svg.append('rect')
        .attr('x', xScale(e.ef)).attr('y', y)
        .attr('width', Math.max(0, xScale(e.ef + e.slack) - xScale(e.ef)))
        .attr('height', barH)
        .attr('rx', 2)
        .attr('fill', color).attr('opacity', 0.1)
        .attr('stroke', color).attr('stroke-width', 0.5).attr('stroke-dasharray', '2 1');
    }

    // Main bar
    const bar = svg.append('rect')
      .attr('x', xScale(e.es)).attr('y', y)
      .attr('width', Math.max(2, xScale(e.ef) - xScale(e.es)))
      .attr('height', barH)
      .attr('rx', 2)
      .attr('fill', color)
      .attr('opacity', e.isCrit ? 0.8 : 0.4)
      .attr('cursor', 'pointer');

    // Critical pulse
    if (e.isCrit) {
      bar.attr('stroke', color).attr('stroke-width', 1);
    }

    // Hover
    bar.on('mouseenter', function() {
      d3.select(this).attr('opacity', 1);
      highlightNodes(new Set([e.name]));
    })
    .on('mouseleave', function() {
      d3.select(this).attr('opacity', e.isCrit ? 0.8 : 0.4);
      clearHighlight();
    });

    // Tiny label for critical path
    if (e.isCrit) {
      svg.append('text')
        .attr('x', xScale(e.es) + 3).attr('y', y + barH - 2)
        .attr('font-family', "'Atkinson Hyperlegible Mono', monospace")
        .attr('font-size', 7)
        .attr('fill', '#fff')
        .attr('pointer-events', 'none')
        .text(e.name.length > 16 ? e.name.substring(0, 14) + '..' : e.name);
    }
  });
}

function renderHistogram(owl) {
  const container = document.getElementById('histogram-container');
  if (!container) return;

  const slacks = [];
  for (const [name, val] of Object.entries(owl)) {
    if (name === '@context') continue;
    slacks.push(val['apercue:slack']);
  }

  const maxSlack = Math.max(...slacks);
  const bins = Array(maxSlack + 1).fill(0);
  slacks.forEach(s => bins[s]++);

  const w = container.clientWidth || 340;
  const h = 60;
  const barW = Math.min(24, (w - 8) / bins.length - 2);
  const maxCount = Math.max(...bins);

  const svg = d3.select(container).append('svg')
    .attr('width', w).attr('height', h);

  bins.forEach((count, i) => {
    const barH = (count / maxCount) * (h - 16);
    const x = 4 + i * (barW + 2);
    const color = i === 0 ? '#3ddc84' : '#2a3545';

    svg.append('rect')
      .attr('x', x).attr('y', h - 12 - barH)
      .attr('width', barW).attr('height', barH)
      .attr('rx', 2)
      .attr('fill', color).attr('opacity', i === 0 ? 0.7 : 0.5);

    svg.append('text')
      .attr('x', x + barW / 2).attr('y', h - 2)
      .attr('text-anchor', 'middle')
      .attr('font-family', "'Atkinson Hyperlegible Mono', monospace")
      .attr('font-size', 8)
      .attr('fill', '#5c6978')
      .text(i);
  });

  // Label
  svg.append('text')
    .attr('x', w - 4).attr('y', 10)
    .attr('text-anchor', 'end')
    .attr('font-family', "'Atkinson Hyperlegible Mono', monospace")
    .attr('font-size', 8)
    .attr('fill', '#5c6978')
    .text('slack (days)');
}

// ═══ Tab 3: Policies (ODRL) ══════════════════
function renderPolicies() {
  const pane = document.getElementById('pane-policies');
  const policies = projData.odrl['odrl:policy'];

  // Parse policies into a matrix-friendly structure
  const matrix = policies.map(p => {
    const uid = p['odrl:uid'];
    const title = p['dcterms:title'];
    const level = uid.includes('unclassified') ? 'Unclassified'
                : uid.includes('protected-a') ? 'Protected A'
                : 'Protected B';
    const cls = uid.includes('unclassified') ? 'unclass'
              : uid.includes('protected-a') ? 'prot-a'
              : 'prot-b';

    const perms = (p['odrl:permission'] || []).map(r => {
      const assignee = (r['odrl:assignee'] || {})['@id'] || '';
      return assignee.split(':').pop().replace(/-/g, ' ');
    });
    const prohibs = (p['odrl:prohibition'] || []).map(r => {
      const assignee = (r['odrl:assignee'] || {})['@id'] || '';
      const action = (r['odrl:action'] || {})['@id'] || '';
      return action.split(':').pop() + ' by ' + assignee.split(':').pop().replace(/-/g, ' ');
    });
    const obligs = (p['odrl:obligation'] || []).map(r => {
      const target = (r['odrl:target'] || {})['@id'] || '';
      return target.split(':').pop().replace(/-/g, ' ');
    });

    return { level, cls, title, perms, prohibs, obligs };
  });

  let html = `<div class="panel-section">
    <div class="panel-section-title">ODRL 2.2 Classification Policies</div>`;

  matrix.forEach(p => {
    html += `<div style="margin-bottom:12px">
      <div style="margin-bottom:6px">
        <span class="classification-badge ${p.cls}">${p.level}</span>
      </div>
      <table class="policy-matrix">
        <tr><td class="col-label">Permitted</td><td>${p.perms.join(', ') || '—'}</td></tr>
        <tr><td class="col-label">Prohibited</td><td>${p.prohibs.join('; ') || '—'}</td></tr>
        <tr><td class="col-label">Obligations</td><td>${p.obligs.join(', ') || '—'}</td></tr>
      </table>
    </div>`;
  });

  html += '</div>';

  // Deadline callout
  html += `<div class="panel-section">
    <div style="font-family:var(--mono);font-size:10px;color:var(--warn);padding:8px 10px;border:1px solid rgba(240,192,64,0.2);border-radius:4px;background:rgba(240,192,64,0.05)">
      Compliance deadline: 2026-06-24 &middot; All policies carry this constraint
    </div>
  </div>`;

  pane.innerHTML = html;
}

// ═══ Tab 4: Provenance (PROV-O) ══════════════
function renderProvenance() {
  const pane = document.getElementById('pane-provenance');
  const graph = projData.prov['@graph'];

  const agents = graph.filter(e => e['@type'] === 'prov:Agent');
  const activities = graph.filter(e => e['@type'] === 'prov:Activity');
  const sources = graph.filter(e => e['@type'] === 'prov:Entity' && e['@id'].includes('source'));
  const facts = graph.filter(e => e['@type'] === 'prov:Entity' && e['@id'].includes('fact'));

  let html = '';

  // Agents
  html += `<div class="panel-section">
    <div class="panel-section-title">Agents (${agents.length})</div>
    <div class="prov-chain">`;
  agents.forEach(a => {
    const delegatesTo = a['prov:actedOnBehalfOf'];
    const detail = delegatesTo ? `acts on behalf of ${delegatesTo['@id'].split(':').pop()}` : '';
    html += `<div class="prov-node">
      <div class="prov-icon agent">A</div>
      <div><div class="prov-title">${a['dcterms:title'] || a['@id']}</div>
      ${detail ? `<div class="prov-detail">${detail}</div>` : ''}</div>
    </div>`;
  });
  html += '</div></div>';

  // Arrow
  html += '<div class="prov-arrow">&#x25BC; attributed to</div>';

  // Activities
  html += `<div class="panel-section">
    <div class="panel-section-title">Activities (${activities.length})</div>
    <div class="prov-chain">`;
  activities.forEach(a => {
    const used = a['prov:used'] || [];
    const generated = a['prov:generated'] || [];
    html += `<div class="prov-node">
      <div class="prov-icon activity">&#x25B6;</div>
      <div><div class="prov-title">${a['dcterms:title'] || a['@id']}</div>
      <div class="prov-detail">Used ${used.length} sources &rarr; generated ${generated.length} facts</div></div>
    </div>`;
  });
  html += '</div></div>';

  html += '<div class="prov-arrow">&#x25BC; used / generated</div>';

  // Sources
  html += `<div class="panel-section">
    <div class="panel-section-title">Sources (${sources.length})</div>
    <div class="prov-chain">`;
  sources.forEach(s => {
    html += `<div class="prov-node">
      <div class="prov-icon source">S</div>
      <div><div class="prov-title">${s['dcterms:title'] || s['@id'].split(':').pop()}</div></div>
    </div>`;
  });
  html += '</div></div>';

  html += '<div class="prov-arrow">&#x25BC; wasDerivedFrom</div>';

  // Facts
  html += `<div class="panel-section">
    <div class="panel-section-title">Facts (${facts.length})</div>
    <div class="prov-chain">`;
  facts.forEach(f => {
    const derived = f['prov:wasDerivedFrom'];
    const srcId = derived ? (derived['@id'] || '').split(':').pop() : '?';
    html += `<div class="prov-node">
      <div class="prov-icon fact">F</div>
      <div><div class="prov-title">${f['dcterms:title'] || f['@id'].split(':').pop()}</div>
      <div class="prov-detail">derived from ${srcId}</div></div>
    </div>`;
  });
  html += '</div></div>';

  pane.innerHTML = html;
}

// ═══ Tab 5: Knowledge (Facts + Sources) ═══════
function renderKnowledge() {
  const pane = document.getElementById('pane-knowledge');
  const graph = projData.prov['@graph'];

  // Extract facts and sources from PROV graph
  const sources = graph.filter(e => e['@type'] === 'prov:Entity' && e['@id'].includes('source'));
  const facts = graph.filter(e => e['@type'] === 'prov:Entity' && e['@id'].includes('fact'));

  let html = '';

  // Sub-tabs
  html += `<div class="sub-tabs">
    <button class="sub-tab active" data-subtab="facts">Facts (${facts.length})</button>
    <button class="sub-tab" data-subtab="sources">Sources (${sources.length})</button>
  </div>`;

  // Facts section
  html += `<div id="subtab-facts">
    <table class="fact-table">`;
  facts.forEach(f => {
    const id = f['@id'].split(':').pop();
    const title = f['dcterms:title'] || id;
    const derived = f['prov:wasDerivedFrom'];
    const srcId = derived ? (derived['@id'] || '').split(':').pop() : '?';
    // Facts from PROV only have title and derivation — show what we have
    html += `<tr>
      <td class="fact-id">${id}</td>
      <td>
        <div class="fact-claim">${title}</div>
        <div class="fact-meta">${srcId} &middot; <span class="confidence-badge verified">verified</span></div>
      </td>
    </tr>`;
  });
  html += '</table></div>';

  // Sources section (hidden by default)
  html += `<div id="subtab-sources" style="display:none">
    <table class="fact-table">`;
  sources.forEach(s => {
    const id = s['@id'].split(':').pop();
    const title = s['dcterms:title'] || id;
    html += `<tr>
      <td class="fact-id">${id}</td>
      <td>
        <div class="fact-claim">${title}</div>
        <div class="fact-meta">prov:Entity &middot; attributed to TBS</div>
      </td>
    </tr>`;
  });
  html += '</table></div>';

  pane.innerHTML = html;

  // Sub-tab switching
  pane.querySelectorAll('.sub-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      pane.querySelectorAll('.sub-tab').forEach(b => b.classList.toggle('active', b === btn));
      document.getElementById('subtab-facts').style.display = btn.dataset.subtab === 'facts' ? '' : 'none';
      document.getElementById('subtab-sources').style.display = btn.dataset.subtab === 'sources' ? '' : 'none';
    });
  });
}

// ═══ Tab 6: Catalog (DCAT) ═══════════════════
function renderCatalog() {
  const pane = document.getElementById('pane-catalog');
  const catalog = projData.dcat;
  const datasets = catalog['dcat:dataset'] || [];

  let html = `<div class="panel-section">
    <div class="panel-section-title">DCAT 3 Catalog &middot; ${datasets.length} deployments</div>
    <div style="font-family:var(--mono);font-size:10px;color:var(--text-dim);margin-bottom:10px">
      ${catalog['dcterms:title'] || 'GC AI Register'}
    </div>`;

  datasets.forEach(ds => {
    const title = ds['dcterms:title'];
    const keywords = ds['dcat:keyword'] || [];
    const conformsTo = ds['dcterms:conformsTo'] || [];

    html += `<div class="catalog-card">
      <div class="catalog-title">${title}</div>
      <div class="catalog-keywords">
        ${keywords.map(k => `<span class="catalog-keyword">${k}</span>`).join('')}
      </div>
      <div class="catalog-conformance">
        Conforms to: ${conformsTo.map(c => {
          const name = (c['dcterms:title'] || c['@id'] || '').replace('urn:gc:directive:', '');
          return `<a href="#" onclick="return false">${name}</a>`;
        }).join(' &middot; ')}
      </div>
    </div>`;
  });

  html += '</div>';

  // Catalog metadata
  html += `<div class="panel-section">
    <div style="font-family:var(--mono);font-size:9px;color:var(--text-dim)">
      Issued: ${catalog['dcterms:issued'] || '—'}<br>
      Publisher: ${(catalog['dcterms:publisher'] || {})['@id'] || '—'}
    </div>
  </div>`;

  pane.innerHTML = html;
}

// ═══ Tab 7: Vocabulary (SKOS) ════════════════
function renderVocabulary() {
  const pane = document.getElementById('pane-vocabulary');
  const concepts = projData.skos['skos:hasTopConcept'] || [];

  // Build a map of concept prefLabel → definition
  const conceptMap = {};
  concepts.forEach(c => {
    conceptMap[c['skos:prefLabel']] = c['skos:definition'];
  });

  let html = `<div class="panel-section">
    <div class="panel-section-title">SKOS ConceptScheme &middot; ${concepts.length} types</div>`;

  // Group by legend categories
  Object.entries(TYPE_GROUPS).forEach(([group, types]) => {
    const groupTypes = types.filter(t => conceptMap[t]);
    if (groupTypes.length === 0) return;

    const color = LEGEND_CATEGORIES[group];
    html += `<div class="glossary-group">
      <div class="glossary-group-title" style="color:${color}">${group}</div>`;

    groupTypes.forEach(t => {
      html += `<div class="glossary-item" data-node-type="${t}">
        <div class="glossary-term" style="color:${TYPE_COLORS[t] || color}">${t}</div>
        <div class="glossary-def">${conceptMap[t]}</div>
      </div>`;
    });

    html += '</div>';
  });

  html += '</div>';
  pane.innerHTML = html;

  // Hover type → highlight all graph nodes of that type
  pane.querySelectorAll('.glossary-item').forEach(el => {
    el.addEventListener('mouseenter', () => {
      const typeName = el.dataset.nodeType;
      const matching = new Set();
      graphData.nodes.forEach(n => {
        if (n.types.includes(typeName)) matching.add(n.id);
      });
      if (matching.size > 0) highlightNodes(matching);
    });
    el.addEventListener('mouseleave', clearHighlight);
  });
}

// ═══ Launch ══════════════════════════════════
init();
</script>
</body>
</html>
