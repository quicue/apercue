name: Validate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install CUE
        uses: cue-lang/setup-cue@v1.0.1
        with:
          version: v0.15.4

      - name: Validate core packages
        run: |
          cue vet ./vocab/
          cue vet ./patterns/
          cue vet ./charter/
          cue vet ./views/

      - name: Validate examples
        run: |
          for d in examples/*/; do
            echo "Validating $d..."
            cue vet "./$d"
          done

      - name: Validate self-charter
        run: cue vet ./self-charter/

      - name: Unicode rejection tests
        run: |
          # These files contain intentional unicode violations.
          # cue vet MUST reject each one (exit code 1).
          PASS=0
          FAIL=0
          for f in tests/unicode-rejection/*.cue; do
            if cue vet "$f" 2>/dev/null; then
              echo "FAIL: $f should have been rejected but passed"
              FAIL=$((FAIL + 1))
            else
              echo "PASS: $f correctly rejected"
              PASS=$((PASS + 1))
            fi
          done
          echo ""
          echo "Unicode rejection: $PASS passed, $FAIL failed"
          if [ "$FAIL" -gt 0 ]; then
            echo "ERROR: Some unicode injection tests were not caught!"
            exit 1
          fi

  deploy:
    needs: validate
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v4

      - name: Install CUE
        uses: cue-lang/setup-cue@v1.0.1
        with:
          version: v0.15.4

      - name: Build public site
        run: |
          mkdir -p site/data site/vocab site/spec
          bash tools/build-site.sh stage _public

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: pages deploy _public --project-name=quicue-apercue
