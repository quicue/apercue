name: Validate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install CUE
        uses: cue-lang/setup-cue@v1.0.1
        with:
          version: v0.15.4

      - name: Validate core packages
        run: |
          cue vet ./vocab/
          cue vet ./patterns/
          cue vet ./charter/
          cue vet ./views/

      - name: Validate examples
        run: |
          for d in examples/*/; do
            echo "Validating $d..."
            cue vet "./$d"
          done

      - name: Validate self-charter
        run: cue vet ./self-charter/

      - name: Unicode rejection tests
        run: |
          # These files contain intentional unicode violations.
          # cue vet MUST reject each one (exit code 1).
          PASS=0
          FAIL=0
          for f in tests/unicode-rejection/*.cue; do
            if cue vet "$f" 2>/dev/null; then
              echo "FAIL: $f should have been rejected but passed"
              FAIL=$((FAIL + 1))
            else
              echo "PASS: $f correctly rejected"
              PASS=$((PASS + 1))
            fi
          done
          echo ""
          echo "Unicode rejection: $PASS passed, $FAIL failed"
          if [ "$FAIL" -gt 0 ]; then
            echo "ERROR: Some unicode injection tests were not caught!"
            exit 1
          fi

  deploy:
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v4

      - name: Install CUE
        uses: cue-lang/setup-cue@v1.0.1
        with:
          version: v0.15.4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Regenerate site data
        run: |
          python3 tools/toposort.py ./self-charter/charter.cue --cue 2>/dev/null > self-charter/precomputed.cue
          mkdir -p site/data site/vocab site/spec
          cue export ./self-charter/ -e charter_viz --out json > site/data/charter.json
          cue export ./self-charter/ -e eco_viz --out json > site/data/ecosystem.json
          cue export ./self-charter/ -e projections --out json > site/data/projections.json
          cue export ./vocab/ -e context --out json > site/vocab/context.jsonld
          cue export ./site/ -e site_specs --out json > site/data/specs.json
          cue export ./site/ -e site_spec_counts --out json > site/data/spec-counts.json

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: pages deploy site --project-name=quicue-apercue
