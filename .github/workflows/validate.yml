name: Validate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install CUE
        uses: cue-lang/setup-cue@v1.0.1
        with:
          version: v0.15.4

      - name: Validate core packages
        run: |
          cue vet ./vocab/
          cue vet ./patterns/
          cue vet ./charter/
          cue vet ./views/

      - name: Validate examples
        run: |
          for d in examples/*/; do
            echo "Validating $d..."
            cue vet "./$d"
          done

      - name: Validate self-charter
        run: cue vet ./self-charter/

      - name: Unicode rejection tests
        run: |
          # These files contain intentional unicode violations.
          # cue vet MUST reject each one (exit code 1).
          PASS=0
          FAIL=0
          for f in tests/unicode-rejection/*.cue; do
            if cue vet "$f" 2>/dev/null; then
              echo "FAIL: $f should have been rejected but passed"
              FAIL=$((FAIL + 1))
            else
              echo "PASS: $f correctly rejected"
              PASS=$((PASS + 1))
            fi
          done
          echo ""
          echo "Unicode rejection: $PASS passed, $FAIL failed"
          if [ "$FAIL" -gt 0 ]; then
            echo "ERROR: Some unicode injection tests were not caught!"
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install W3C validation dependencies
        run: pip install rdflib pyshacl

      - name: W3C round-trip conformance
        run: python3 tools/validate-w3c.py -v

      - name: No hardcoded absolute paths in markdown
        run: |
          # Catch /home/*, /Users/*, /tmp/* paths that sneak into docs.
          FOUND=0
          for f in $(find . -name '*.md' -not -path './.git/*' -not -path './node_modules/*'); do
            if grep -nE '(/home/|/Users/|/tmp/)' "$f"; then
              echo "  ^ in $f"
              FOUND=$((FOUND + 1))
            fi
          done
          if [ "$FOUND" -gt 0 ]; then
            echo ""
            echo "ERROR: $FOUND file(s) contain hardcoded absolute paths"
            exit 1
          fi
          echo "No hardcoded absolute paths found"

      - name: README command smoke test
        run: |
          # Parse and run every cue command from example READMEs (ADR-016).
          PASS=0
          FAIL=0
          for readme in examples/*/README.md; do
            dir="$(dirname "$readme")"
            # Extract lines starting with cue from ```bash blocks
            in_block=false
            while IFS= read -r line; do
              if echo "$line" | grep -q '```bash'; then
                in_block=true
                continue
              fi
              if echo "$line" | grep -q '```'; then
                in_block=false
                continue
              fi
              if $in_block && echo "$line" | grep -qE '^\s*(cue (vet|eval|export))'; then
                cmd=$(echo "$line" | sed 's/^\s*//')
                echo "RUN: $cmd"
                if eval "$cmd" > /dev/null 2>&1; then
                  PASS=$((PASS + 1))
                else
                  echo "  FAIL: $cmd"
                  FAIL=$((FAIL + 1))
                fi
              fi
            done < "$readme"
          done
          echo ""
          echo "README commands: $PASS passed, $FAIL failed"
          if [ "$FAIL" -gt 0 ]; then
            exit 1
          fi

  deploy:
    needs: validate
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v4

      - name: Install CUE
        uses: cue-lang/setup-cue@v1.0.1
        with:
          version: v0.15.4

      - name: Build public site
        run: |
          mkdir -p site/data site/vocab site/spec
          bash tools/build-site.sh stage _public

      - name: Deploy to Cloudflare Pages
        run: |
          npx wrangler pages project create quicue-apercue --production-branch=main || echo "Project may already exist"
          npx wrangler pages deploy _public --project-name=quicue-apercue --branch=main
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        continue-on-error: true
